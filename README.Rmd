---
title: Tools to Support Relative Importance Analysis
output: github_document
---

```{r setup, echo=FALSE, message=FALSE}
devtools::load_all()
```

# Overview

The intention of the `{domir}` package is to provide tools that allow relative 
importance analysis across a wide variety of practical data analytic situations.
With `{domir}`, if you have a statistical/machine learning model and an extractor 
function to obtain a fit metric, you can conduct a relative importance analysis.

More specifically, `{domir}` is intended to implement a set of flexible wrapper 
and helper functions for conducting relative importance analysis and the 
current implementation of the package has a focus on dominance analysis with 
the `domin` function as a relative importance analysis method.  Currently, 
`domin` is the only importance function that is implemented.

For readers looking to familiarize themselves more with the dominance 
analysis methodology, a more extensive conceptual discussion of dominance 
analysis (which focuses on the Stata version of `domin`) as a method is 
available [here](https://github.com/jluchman/domin/blob/master/README.md).

# Installation

To install the most recent stable version of `domir` from CRAN use:

`install.packages("domir")`

To install the working development version of `{domir}` using the `devtools` 
package use:

`devtools::install_github("https://github.com/jluchman/domir")`

# What `{domir}` Does

Before discussing details of the `{domir}` package, I provide some examples of 
what `{domir}` can do.

The focus of this section is on outlining how `domir::domin` extends existing 
packages and on the structure of the function.

## Comparison with Existing Relative Importance Packages

Fundamentally, `domir::domin` is an extension of the "lmg" type for the 
`calc.relimpo` function in the `{relaimpo}` package as well as the 
`dominanceAnalysis` function in the `{dominanceanalysis}` package.

`domir::domin` can replicate the results produced by the above packages but, as 
will be seen, requires a "deconstructed" the model to be submitted to it.  This 
difference in structure does make `domin` more complex but also allows the 
function a great deal more flexibility in terms of the kinds of models and 
fit metrics that can be dominance analyzed.

Before discussing some of the elements that make `domin` flexible, consider the 
following example that shows how `domin` is similar to existing packages. All 
three of the dominance analysis results to come are based on the following 
linear model:

`lm(mpg ~ am + vs + cyl, data = mtcars)`

The variance explained $R^2$ will be the focal fit metric.

### `{domir}`'s `domin`

```{r init_domin}
domin(mpg ~ am + vs + cyl, 
      lm, 
      list(summary, "r.squared"), 
      data = mtcars)
```

In `domin`, the `lm` model is submitted in pieces.  Specifically, the key inputs 
were the formula (`mpg ~ am + vs + cyl`) and the model to be called using 
the formula (`lm`).  In this way, `domin` is a `Map`- or `apply`-like 
function as it receives an object on which to operate (i.e., the formula) and 
a function to which to apply to it.

In being like `apply`, `domin` is agnostic to the fit metric to use for the 
model called and it must be supplied with a list outlining extractor function 
information (`list(summary, "r.squared")`; described further in the
[Details](#Details) section).

Like `apply`, other arguments (`data = mtcars`) can also be passed to each 
call of `lm`.

The focus of `domin`'s `print`-ed results focuses on the numerical results from 
"General Dominance Statistics" and "Conditional Dominance Statistics" and, a 
logical matrix of "Complete Dominance Designations".

### `{relaimpo}`'s `calc.relimp` with "lmg"

``` {r init_relaimpo}
relaimpo::calc.relimp(mpg ~ am + vs + cyl, 
                      data = mtcars, 
                      type = "lmg")
```

`{relaimpo}`'s `calc.relimp` accepts only `lm` models and the variance explained 
$R^2$ as a fit metric.  As a result, the function does not ask for model
or fit metric type.

The function's printed results provide the "lmg" relative importance statistics 
(i.e., General Dominance Statistics) and, in addition, report the average `lm` 
coefficients across all models.

### `{dominanceanalysis}`'s `dominanceAnalysis`

``` {r init_da}
dominanceanalysis::dominanceAnalysis(lm(mpg ~ am + vs + cyl, 
                                        data = mtcars))
```

`{dominanceanalysis}`'s `dominanceAnalysis` implements dominance analysis 
for specific models, of which `lm` is a supported model. 
`dominanceAnalysis` accepts a fitted `lm` object as input and uses the 
explained variance $R^2$ as the fit metric.

`dominanceAnalysis`'s printed output is focused on qualitative dominance 
designations but also reports the, magnitude sorted, average contribution
(i.e., General Dominance Statistic) values.

## How `{domir}` Extends on Previous Packages

The intention of `{domir}` is to extend relative importance to new data 
analytic situations the user might encounter where a dominance analysis 
could be valuable.

The sections below outline some pertinent examples of specific models that the
`domin` function can accommodate.

### Linear Model Revisited

`domin` is fit metric agnostic and, as such, one component of its flexibility 
is in allowing the user to apply any applicable fit metric for a model for
the purposes of relative importance analysis.

In this example, the explained variance $R^2$ is swapped with an alternative, 
but nonetheless applicable, fit metric: the McFadden pseudo-$R^2$ as 
implemented by the `{pscl}` package.

Note the use of the pipes to `capture.output` and `invisible`.  These are not
not strictly necessary but if not used will print far more output than is 
needed as `pscl::pR2` is a rather verbose function and will print a message for 
each model fitted.

```{r lm_w_mcf}
(mcf_da_lm <- 
   domin(mpg ~ am + vs + cyl, 
         lm, 
         list(pscl::pR2, "McFadden"), 
         data = mtcars)) |> 
  capture.output() |> 
  invisible()

mcf_da_lm
```

Note that this fit metric produces effectively the same answers, in terms of 
qualitative importance inferences about the predictors, as that from the 
explained variance $R^2$.

### Ordered Logistic Regression

`domin` acts like an `apply` function for models and does not have built in 
methods. This is another component of its flexibility as it can  accommodate 
functions that, to this point, have not been supported in relative importance 
analysis.  One pertinent example is the `polr` function from the `{MASS}` 
package also using `pscl::pR2` as fit metric.

```{r da_polr}
mtcars2 <- data.frame(mtcars, carb2 = as.factor(mtcars$carb))

(da_polr <- 
    domin(carb2 ~ am + vs + mpg, 
          MASS::polr, 
          list(pscl::pR2, "McFadden"), 
          data = mtcars2)) |> 
  capture.output() |> 
  invisible()

da_polr
```

### Decision Trees

`domin` can also accept models that do not produce model coefficients like 
`rpart::rpart`. 

```{r da_rpart}
domin(mpg ~ am + vs + cyl, 
      rpart::rpart, 
      list(\(model) 
            list(R2 = 1-model$cptable[nrow(model$cptable), 3]), 
            "R2"),
      data = mtcars)
```

Note that an anonymous function can be used as a valid submission to 
the `fitstat` argument.  In this case, the anonymous function transforms and 
extracts the proportion of error from the `rpart` object.  If the model 
object returns its own fit statistic, it can be extracted using an 
anonymous function.

### Multinomial Logistic (softmax) Regression with Extra Features

`domin`, similar to other packages, can combine multiple predictors into a 
single set as well as use one or more predictors as covariate(s) in all model 
subsets.

This example outlines another model, `multinom` from the `{nnet}` package,  
another function that has not been accommodated in relative importance 
packages, that uses sets and all/covariate predictors.

In addition, `complete = FALSE` which saves a little computation time and 
suppresses reporting complete dominance designations.

```{r da_multinom}
(da_mnl <- 
  domin(carb2 ~ mpg, 
      nnet::multinom, 
      list(pscl::pR2, "McFadden"), 
      sets = list(c("am", "vs"), c("cyl", "disp")),
      all = c("gear"),
      complete = FALSE,
      data = mtcars2)) |> 
  capture.output() |> 
  invisible()

da_mnl

da_mnl$Subset_Details$Full_Model
```

The `domin` automatically combines the entries in the `formula_overall`, 
`sets`, and `all` arguments. The full model formula can be obtained from the 
`domin` object in the `.$Subset_Details$Full_Model` element.

### Zero-Inflated Poisson with Wrapper Function

Although `domin` can work directly with modeling functions that accept 
standard formula, more complex formulas such as those used by models such as 
`zeroinfl` models from the package `{pscl}` can also be accommodated using 
wrapper functions.

The below wrapper function`zinfl_wrap` uses the entries in the formula to 
create a symmetric count and zero-inflation formulas that will be submitted 
to `zeroinfl` model.  

In an effort to illustrate what each model submitted to `zeroinfl` looks like,
the model formula for all 7 models is printed before each run.

```{r da_zip}
zinfl_wrap <- function(model, ...) {
  zip_terms <- model |> terms() |> attr("term.labels") |> paste(collapse = " + ")
  zip_formula_rhs <- zip_terms |> rep(times = 2) |> paste(collapse = " | ")
  zip_formula_lhs <- (model |> all.vars())[[1]]
  zip_formula <- c(zip_formula_lhs, zip_formula_rhs) |> paste(collapse = " ~ ") |> as.formula()
  print(deparse(zip_formula))
  pscl::zeroinfl(zip_formula, ...)
}

domin(art ~ fem + mar + kid5, 
      zinfl_wrap,
      list(\(model) {capture.output(result <- pscl::pR2(model)); result}, "McFadden"), 
      data=pscl::bioChemists)
```

Further discussion of how to generate wrapper commands is outlined below in the 
[Details](#Details) section.

----

# Details

** section in progress **

`{domir}` implements dominance analysis using the `domin` function.

`domin` acts as a `Map`- or `apply`-like function that takes three 'building 
block' arguments:

1. a formula (`formula_overall`)
2. a modeling function (`reg`)
3. list of instructions to call an extractor function that obtains a model fit metric (`fitstat`)

The three arguments above effectively invoke the following process (using the 
new `|>` forward pipe operator notation in R 4.1).

`reg(formula_overall) |> fitstat()`

Hence, the `reg` function is called using the `formula_overall` as argument and 
the results of the `reg` model are are 'piped' to `fitstat`.

## formula

The key argument for `domin` is the formula input and understanding how it is 
parsed is important for the effective use of `domin`.

The formula argument is parsed using the `terms` utilities in the `stats` 
library.  Generally, 

and is not 'data frame aware'.  That is, shorthand such as `~ .` 
will not work to select variables in a data frame even if a `data` argument 
is supplied to the `domin` function.

```r{formula_example}
formula(mpg ~ .) |> terms(data=mtcars) |> formula()
```


...note all and sets go here as well

many modeling functions that accept a formula that follow the 
standard `response ~ terms` format. 

`domin` works closely with the `do.call` function and the structure of the 
`domin` function is similar as a result.  Users are encouraged to 
read the documentation for the `do.call` function to understand how `domin` is 
implemented and for bug/error checking.

wrapper function that can be used with 
The format used by domin can be extended 
to other functions focused on independent variable/predictor/feature-based RI 
can be accommodated with a additional wrapper functions based 
on the formula it creates and submits to modeling functions.  Some examples are
offered below.



The `{domir}` package is aimed at offering users tools for applying relative 
importance/RI analysis to a wide variety of statistical or machine learning 
functions.  In addition, this package aims to allow users to apply new 
fit statistics or metrics to statistical or machine learning 
functions that already have RI analysis implementations such as `lm`.

Currently, the only RI tool implemented in `{domir}` is a dominance analysis 
method `domin`. 
